<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whyio - Admin Product Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d; /* Dark Background */
            color: #e5e5e5;
        }
        .container-bg {
            background-color: #1a1a1a;
            border-color: #262626;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background-color: #3b82f6;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .input-field {
            background-color: #262626;
            border-color: #3f3f46;
            color: #e5e5e5;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-blue-400">Whyio Product Admin Panel</h1>
            <p class="mt-2 text-gray-400">Manage your product inventory for all collection pages.</p>
            <p class="mt-4 p-2 bg-yellow-900 border border-yellow-700 text-yellow-300 rounded text-sm">
                ⚠️ **SECURITY WARNING**: This panel is currently client-side only. You **MUST** implement Firebase Authentication and Firestore Security Rules before deployment.
            </p>
        </header>

        <div class="container-bg max-w-4xl mx-auto p-6 rounded-lg border border-gray-700 mb-12">
            <h2 id="form-title" class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Add New Product</h2>
            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                
                <div>
                    <label for="name" class="block text-sm font-medium mb-1">Product Name</label>
                    <input type="text" id="name" required class="input-field w-full p-2 rounded border focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="price" class="block text-sm font-medium mb-1">Price ($)</label>
                        <input type="number" id="price" required step="0.01" class="input-field w-full p-2 rounded border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium mb-1">Category (Used for filtering on collection pages)</label>
                        <select id="category" required class="input-field w-full p-2 rounded border focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Select Category --</option>
                            <option value="classic_tees">Classic T-Shirts</option>
                            <option value="drop-shoulder-tees">Drop-Shoulder Tees</option>
                            <option value="polo_shirts">Polo Shirts</option>
                            <option value="all">General/All (for index.html)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="imageUrl" class="block text-sm font-medium mb-1">Image URL</label>
                    <input type="url" id="imageUrl" required class="input-field w-full p-2 rounded border focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., https://example.com/product-image.jpg">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="description" required rows="3" class="input-field w-full p-2 rounded border focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-between items-center pt-2">
                    <button type="submit" id="submit-button" class="btn-primary text-white font-semibold py-2 px-4 rounded transition-all">
                        <span id="submit-text">Add Product</span>
                    </button>
                    <button type="button" id="cancel-edit" class="text-gray-400 hover:text-gray-200 transition-colors hidden" onclick="resetForm()">
                        Cancel Edit
                    </button>
                </div>
            </form>
        </div>

        <div class="container-bg max-w-4xl mx-auto p-6 rounded-lg border border-gray-700">
            <h2 class="text-2xl font-semibold mb-6 border-b border-gray-700 pb-2">Existing Products</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Product</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Price</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Category</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-list-body" class="divide-y divide-gray-700">
                        <tr id="loading-row"><td colspan="4" class="py-4 text-center text-gray-500">Loading products...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        // --- 1. CONFIG & IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            setDoc, 
            deleteDoc, 
            query, 
            orderBy,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDUPc96npoIO55MiX-vnpuLMISYzosc9sA",
            authDomain: "whyio000.firebaseapp.com",
            projectId: "whyio000",
            storageBucket: "whyio000.firebasestorage.app",
            messagingSenderId: "675601432291",
            appId: "1:675601432291:web:3bf62d7583865fbaca8fd6",
            measurementId: "G-B07F6ZB1CY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productsRef = collection(db, "products");
        
        // --- 2. DOM Elements ---
        const form = document.getElementById('product-form');
        const listBody = document.getElementById('product-list-body');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const cancelButton = document.getElementById('cancel-edit');
        const loadingRow = document.getElementById('loading-row');

        // --- 3. CRUD: CREATE / UPDATE (Upsert) ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const name = document.getElementById('name').value;
            const price = parseFloat(document.getElementById('price').value);
            const category = document.getElementById('category').value;
            const imageUrl = document.getElementById('imageUrl').value;
            const description = document.getElementById('description').value;

            const productData = {
                name,
                price,
                category,
                imageUrl,
                description,
                // Add a timestamp for ordering
                timestamp: serverTimestamp(),
            };

            try {
                // If productId exists, we are UPDATING (using setDoc with ID)
                if (productId) {
                    await setDoc(doc(db, "products", productId), productData);
                    alert('Product updated successfully!');
                } 
                // If no productId, we are CREATING (using setDoc without ID for auto-generation)
                else {
                    // Uses doc() without an ID to create a new document reference with an auto-generated ID, 
                    // then uses setDoc() to write the data to that reference.
                    await setDoc(doc(productsRef), productData); 
                    alert('Product added successfully!');
                }
                resetForm();

            } catch (error) {
                console.error("Error saving product:", error);
                alert('Failed to save product. Check console.');
            }
        });

        // --- 4. CRUD: READ (Real-time Listener) ---
        
        // Set up a real-time listener for the products collection
        onSnapshot(query(productsRef, orderBy('timestamp', 'desc')), (snapshot) => {
            listBody.innerHTML = ''; // Clear the current list
            loadingRow.remove(); // Remove loading state once data is received

            if (snapshot.empty) {
                listBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No products found. Add one above!</td></tr>`;
                return;
            }

            snapshot.forEach((doc) => {
                const product = doc.data();
                const id = doc.id;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${product.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap">$${product.price.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-blue-400">${product.category.replace(/_/g, ' ')}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-right space-x-2">
                        <button class="text-yellow-500 hover:text-yellow-400 font-medium" onclick="editProduct('${id}', '${encodeURIComponent(JSON.stringify(product))}')">Edit</button>
                        <button class="text-red-500 hover:text-red-400 font-medium" onclick="deleteProduct('${id}', '${product.name}')">Delete</button>
                    </td>
                `;
                listBody.appendChild(row);
            });
        }, (error) => {
            console.error("Error reading products:", error);
            listBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-500">Failed to load products.</td></tr>`;
        });


        // --- 5. CRUD: DELETE ---

        window.deleteProduct = async (id, name) => {
            if (confirm(`Are you sure you want to delete the product: "${name}"?`)) {
                try {
                    await deleteDoc(doc(db, "products", id));
                    // The onSnapshot listener will automatically refresh the list
                    alert(`Product "${name}" deleted successfully.`);
                } catch (error) {
                    console.error("Error deleting product:", error);
                    alert('Failed to delete product. Check console.');
                }
            }
        };

        // --- 6. Edit & Form Helpers ---

        window.editProduct = (id, encodedProduct) => {
            // Decode the product object that was passed as a string
            const product = JSON.parse(decodeURIComponent(encodedProduct));
            
            // Populate the form fields
            document.getElementById('product-id').value = id;
            document.getElementById('name').value = product.name;
            document.getElementById('price').value = product.price;
            document.getElementById('category').value = product.category;
            document.getElementById('imageUrl').value = product.imageUrl;
            document.getElementById('description').value = product.description;

            // Update UI for editing state
            formTitle.textContent = 'Edit Product: ' + product.name;
            submitText.textContent = 'Save Changes';
            submitButton.classList.remove('btn-primary');
            submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelButton.classList.remove('hidden');
            
            // Scroll to the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.resetForm = () => {
            form.reset();
            document.getElementById('product-id').value = '';
            
            // Reset UI for 'Add New Product' state
            formTitle.textContent = 'Add New Product';
            submitText.textContent = 'Add Product';
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitButton.classList.add('btn-primary');
            cancelButton.classList.add('hidden');
        };

        // Initial check to remove the loading row if the database fails to connect immediately
        // (The onSnapshot listener will handle the final state)
        document.addEventListener('DOMContentLoaded', () => {
            if(listBody.contains(loadingRow)) {
                // If it's still there after a small delay, ensure the element is created
                // and the listener will replace it when it fires.
            }
        });
        
    </script>
</body>
</html>